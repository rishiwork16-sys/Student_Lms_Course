<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - skilledUp</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Poppins:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/student.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        /* Exam Results Section */
        .results-section {
            margin-top: 40px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 16px;
        }

        .result-card {
            background: #fff;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.07);
            border: 1px solid #e8ecf4;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .result-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .result-card.passed::before {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .result-card.failed::before {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .result-card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
        }

        .result-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-badge.pass {
            background: #d1fae5;
            color: #065f46;
        }

        .result-badge.fail {
            background: #fee2e2;
            color: #991b1b;
        }

        .result-exam-title {
            font-size: 17px;
            font-weight: 700;
            color: #1a202c;
            margin: 0 0 4px;
        }

        .result-course {
            font-size: 13px;
            color: #6b7280;
            margin: 0 0 14px;
        }

        .result-course i {
            margin-right: 4px;
        }

        .result-score-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .result-score-big {
            font-size: 28px;
            font-weight: 800;
        }

        .result-score-big.pass {
            color: #10b981;
        }

        .result-score-big.fail {
            color: #ef4444;
        }

        .result-score-label {
            font-size: 13px;
            color: #9ca3af;
            line-height: 1.3;
        }

        .marks-bar-bg {
            background: #f3f4f6;
            border-radius: 99px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .marks-bar-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 0.8s ease;
        }

        .marks-bar-fill.pass {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .marks-bar-fill.fail {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .result-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #9ca3af;
        }

        .result-module {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 6px;
        }

        .results-empty {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
            background: #f9fafb;
            border-radius: 12px;
            border: 2px dashed #e5e7eb;
        }

        .results-empty i {
            font-size: 36px;
            margin-bottom: 10px;
            display: block;
        }

        /* Review Modal */
        .review-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            z-index: 99999;
            justify-content: center;
            align-items: flex-start;
            overflow-y: auto;
            padding: 30px 16px;
        }

        .review-modal-overlay.open {
            display: flex;
        }

        .review-modal {
            background: #fff;
            border-radius: 20px;
            width: 100%;
            max-width: 700px;
            margin: auto;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
            animation: slideUpModal 0.3s ease;
        }

        @keyframes slideUpModal {
            from {
                transform: translateY(40px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .review-modal-header {
            background: linear-gradient(135deg, #6366f1, #818cf8);
            color: #fff;
            padding: 22px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .review-modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .review-modal-header p {
            margin: 4px 0 0;
            font-size: 13px;
            opacity: 0.85;
        }

        .review-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
            font-size: 20px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .review-score-banner {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 28px;
            background: #f8f9ff;
            border-bottom: 1px solid #e8ecf4;
        }

        .review-score-num {
            font-size: 36px;
            font-weight: 800;
        }

        .review-score-num.pass {
            color: #10b981;
        }

        .review-score-num.fail {
            color: #ef4444;
        }

        .review-score-info p {
            margin: 0;
            font-size: 13px;
            color: #6b7280;
        }

        .review-score-info strong {
            font-size: 15px;
            color: #1a202c;
        }

        .review-pass-badge {
            margin-left: auto;
            padding: 6px 18px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
        }

        .review-pass-badge.pass {
            background: #d1fae5;
            color: #065f46;
        }

        .review-pass-badge.fail {
            background: #fee2e2;
            color: #991b1b;
        }

        .review-questions {
            padding: 20px 28px 28px;
        }

        .review-q {
            border: 1.5px solid #e8ecf4;
            border-radius: 14px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .review-q-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            background: #f8f9ff;
            border-bottom: 1px solid #e8ecf4;
        }

        .q-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            flex-shrink: 0;
        }

        .q-num.correct {
            background: #d1fae5;
            color: #065f46;
        }

        .q-num.wrong {
            background: #fee2e2;
            color: #991b1b;
        }

        .review-q-text {
            font-weight: 600;
            color: #1a202c;
            font-size: 14px;
            flex: 1;
        }

        .q-marks-badge {
            font-size: 12px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 12px;
        }

        .q-marks-badge.correct {
            background: #d1fae5;
            color: #065f46;
        }

        .q-marks-badge.wrong {
            background: #fee2e2;
            color: #991b1b;
        }

        .review-q-body {
            padding: 14px 18px;
        }

        .student-answer-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .student-answer-row.correct-ans {
            background: #f0fdf4;
            border: 1.5px solid #6ee7b7;
        }

        .student-answer-row.wrong-ans {
            background: #fff1f2;
            border: 1.5px solid #fca5a5;
        }

        .student-answer-row i {
            margin-top: 2px;
            flex-shrink: 0;
        }

        .review-remarks {
            font-size: 12px;
            color: #6b7280;
            background: #f9fafb;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 6px;
        }

        .review-modal-loading {
            text-align: center;
            padding: 60px;
            color: #9ca3af;
        }

        .btn-view-review {
            width: 100%;
            margin-top: 12px;
            padding: 9px;
            background: transparent;
            border: 1.5px solid #6366f1;
            color: #6366f1;
            border-radius: 10px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        .btn-view-review:hover {
            background: #6366f1;
            color: #fff;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <h2><i class="fas fa-graduation-cap" style="color:#3b82f6; margin-right:10px;"></i>skilledUp</h2>
        <button class="nav-toggle" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button>
        <div class="nav-links" id="dashNavLinks">
            <div class="nav-group">
                <a href="#my-courses" class="active"><i class="fas fa-book"></i> My Courses</a>
                <a href="#my-results" onclick="scrollToResults()"><i class="fas fa-chart-bar"></i> My Results</a>
                <a href="javascript:void(0)" onclick="goToProfile()" style="cursor: pointer;"><i
                        class="fas fa-user"></i> My Profile</a>
            </div>
            <div class="user-group" style="position: relative; z-index: 9999;">
                <a href="profile.html" class="user-pill-link"
                    style="text-decoration: none; cursor: pointer !important;">
                    <span class="user-pill" style="cursor: pointer !important; pointer-events: auto !important;">
                        <i class="fas fa-user-circle"></i>
                        <span class="user-name">Welcome, <strong id="userNameDisplay">Student</strong></span>
                    </span>
                </a>
                <a href="#" onclick="logout()" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <header class="dashboard-hero">
            <div class="hero-content">
                <h1><i class="fas fa-graduation-cap"></i> My Learning Dashboard</h1>
                <p>Track progress, continue learning, and access certificates</p>
            </div>
        </header>

        <section id="my-courses" class="section-block">
            <div class="section-header">
                <h3><i class="fas fa-book-reader"></i> My Enrolled Courses</h3>
            </div>
            <div class="courses-grid" id="enrolledGrid">
                <p>Loading your courses...</p>
            </div>
        </section>

        <!-- MY EXAM RESULTS SECTION -->
        <section id="my-results" class="section-block results-section">
            <div class="section-header">
                <h3><i class="fas fa-chart-bar" style="color:#6366f1;"></i> My Exam Results</h3>
            </div>
            <div class="results-grid" id="resultsGrid">
                <div class="results-empty">
                    <i class="fas fa-spinner fa-spin"></i>
                    Loading your results...
                </div>
            </div>
        </section>
    </div>

    <!-- EXAM REVIEW MODAL -->
    <div class="review-modal-overlay" id="reviewModalOverlay" onclick="closeReviewModal(event)">
        <div class="review-modal" id="reviewModal">
            <div class="review-modal-header">
                <div>
                    <h2 id="reviewExamTitle">Exam Review</h2>
                    <p id="reviewExamSub">Your answer breakdown</p>
                </div>
                <button class="review-close-btn" onclick="closeReviewModalDirect()"><i
                        class="fas fa-times"></i></button>
            </div>
            <div id="reviewModalBody">
                <div class="review-modal-loading"><i class="fas fa-spinner fa-spin"
                        style="font-size:32px;"></i><br>Loading review...</div>
            </div>
        </div>
    </div>
    <script src="../js/shared.js"></script>
    <script src="../js/student.js"></script>
    <script>
        function goToProfile() {
            window.location.href = "profile.html";
        }
        function scrollToResults() {
            document.getElementById('my-results').scrollIntoView({ behavior: 'smooth' });
        }

        const userName = localStorage.getItem('userName');
        if (userName) {
            document.getElementById('userNameDisplay').textContent = userName;
        }

        // Load dashboard and results
        loadStudentDashboard();
        loadMyExamResults();

        async function loadMyExamResults() {
            const grid = document.getElementById('resultsGrid');
            try {
                const res = await fetchWithAuth('/student/my-results');
                if (!res.ok) throw new Error('Failed');
                const results = await res.json();
                if (!results || results.length === 0) {
                    grid.innerHTML = `
                        <div class="results-empty" style="grid-column:1/-1;">
                            <i class="fas fa-clipboard-list"></i>
                            <p><strong>No exam results yet</strong></p>
                            <p style="font-size:13px;">Complete exams in your courses to see your marks here.</p>
                        </div>`;
                    return;
                }
                grid.innerHTML = results.map(r => {
                    const percent = r.totalQuestions > 0
                        ? Math.round((r.obtainedMarks / r.totalQuestions) * 100)
                        : 0;
                    const isPassed = r.passed;
                    const cls = isPassed ? 'pass' : 'fail';
                    const date = r.submittedAt ? new Date(r.submittedAt.replace('T', ' ')).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                    return `
                        <div class="result-card ${isPassed ? 'passed' : 'failed'}" style="cursor: pointer;" onclick="openReviewModal(${r.submissionId}, '${(r.examTitle || '').replace(/'/g, "'")}', ${isPassed})">
                            <div class="result-card-top">
                                <div>
                                    <h4 class="result-exam-title">${r.examTitle}</h4>
                                    <p class="result-course"><i class="fas fa-graduation-cap"></i>${r.courseName || 'Course'}</p>
                                </div>
                                <span class="result-badge ${cls}">${isPassed ? '✅ Passed' : '❌ Failed'}</span>
                            </div>
                            ${r.moduleTitle ? `<div class="result-module"><i class="fas fa-folder-open"></i> ${r.moduleTitle}</div>` : ''}
                            <div class="result-score-row">
                                <div class="result-score-big ${cls}">${r.obtainedMarks}/${r.totalQuestions}</div>
                                <div class="result-score-label">
                                    marks<br>
                                    <span style="color:#6366f1;">Pass: ${r.passingMarks}</span>
                                </div>
                            </div>
                            <div class="marks-bar-bg">
                                <div class="marks-bar-fill ${cls}" style="width: ${Math.min(percent, 100)}%;"></div>
                            </div>
                            <div class="result-meta">
                                <span><i class="fas fa-percent"></i> ${percent}% score</span>
                                <span><i class="fas fa-calendar-alt"></i> ${date}</span>
                            </div>
                            <button class="btn-view-review" onclick="event.stopPropagation(); openReviewModal(${r.submissionId}, '${(r.examTitle || '').replace(/'/g, "'")}', ${isPassed})"><i class="fas fa-eye"></i> View Question-wise Review</button>
                        </div>`;
                }).join('');
            } catch (e) {
                grid.innerHTML = `<div class="results-empty" style="grid-column:1/-1;"><i class="fas fa-exclamation-circle"></i><p>Could not load results.</p></div>`;
            }
        }

        async function openReviewModal(submissionId, examTitle, passed) {
            const overlay = document.getElementById('reviewModalOverlay');
            const body = document.getElementById('reviewModalBody');
            document.getElementById('reviewExamTitle').textContent = examTitle;
            document.getElementById('reviewExamSub').textContent = 'Your answer breakdown';
            body.innerHTML = '<div class="review-modal-loading"><i class="fas fa-spinner fa-spin" style="font-size:32px;"></i><br>Loading review...</div>';
            overlay.classList.add('open');
            document.body.style.overflow = 'hidden';
            try {
                const res = await fetchWithAuth(`/student/my-results/${submissionId}/review`);
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                const cls = data.passed ? 'pass' : 'fail';
                let html = `
                    <div class="review-score-banner">
                        <div>
                            <div class="review-score-num ${cls}">${data.obtainedMarks}/${data.totalQuestions}</div>
                            <div class="review-score-info">
                                <p>marks obtained</p>
                                <strong>Pass mark: ${data.passingMarks}</strong>
                            </div>
                        </div>
                        <span class="review-pass-badge ${cls}">${data.passed ? '✅ Passed' : '❌ Failed'}</span>
                    </div>
                    <div class="review-questions">
                        <p style="font-size:13px;color:#9ca3af;margin:0 0 14px;">* Correct answers are not shown. Green = you got it right, Red = incorrect.</p>`;
                (data.questions || []).forEach((q, idx) => {
                    const correct = q.isCorrect;
                    const qcls = correct ? 'correct' : 'wrong';
                    const icon = correct ? 'fa-check' : 'fa-times';
                    const iconColor = correct ? '#10b981' : '#ef4444';
                    html += `
                        <div class="review-q">
                            <div class="review-q-header">
                                <div class="q-num ${qcls}">${idx + 1}</div>
                                <div class="review-q-text">${q.questionText || 'Question'}</div>
                                <span class="q-marks-badge ${qcls}">${q.marksObtained}/${q.maxMarks} marks</span>
                            </div>
                            <div class="review-q-body">
                                <div class="student-answer-row ${correct ? 'correct-ans' : 'wrong-ans'}">
                                    <i class="fas ${icon}" style="color:${iconColor};"></i>
                                    <div>
                                        <div style="font-size:11px;color:#9ca3af;margin-bottom:2px;">Your Answer</div>
                                        <strong>${q.studentAnswer || '(No answer given)'}</strong>
                                    </div>
                                </div>
                                ${q.adminRemarks ? `<div class="review-remarks"><i class="fas fa-comment-alt" style="margin-right:5px;"></i>${q.adminRemarks}</div>` : ''}
                            </div>
                        </div>`;
                });
                html += '</div>';
                body.innerHTML = html;
            } catch (e) {
                body.innerHTML = '<div class="review-modal-loading"><i class="fas fa-exclamation-circle" style="font-size:32px;color:#ef4444;"></i><br>Could not load review. Please try again.</div>';
            }
        }
        function closeReviewModal(e) {
            if (e.target === document.getElementById('reviewModalOverlay')) closeReviewModalDirect();
        }
        function closeReviewModalDirect() {
            document.getElementById('reviewModalOverlay').classList.remove('open');
            document.body.style.overflow = '';
        }
    </script>
</body>

</html>